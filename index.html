<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Suspect Online (Firestore)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b1220; color: #e7ecff; }
    .wrap { max-width: 860px; margin: 0 auto; padding: 14px; }
    .card { background:#121b2f; border:1px solid #223055; border-radius:14px; padding:14px; margin: 10px 0; }
    h1 { font-size: 20px; margin: 6px 0 10px; }
    h2 { font-size: 16px; margin: 0 0 10px; opacity:.95;}
    input, button, select { font-size: 16px; padding: 10px 12px; border-radius: 12px; border:1px solid #2a3c67; background:#0c1530; color:#e7ecff; }
    button { background:#2a55ff; border:none; cursor:pointer; }
    button.secondary { background:#223055; }
    button.danger { background:#ff3b4d; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row > * { flex:1; min-width: 160px; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#0c1530; border:1px solid #2a3c67; margin: 4px 6px 0 0; font-size: 13px; }
    .muted { opacity:.75; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; white-space: pre-wrap; background:#0c1530; border:1px solid #2a3c67; border-radius:12px; padding:10px; max-height: 260px; overflow:auto;}
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:720px){ .grid2 { grid-template-columns: 1fr; } }
    .tiny { font-size: 12px; opacity:.85; }
    .err { color:#ffb4b4; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üïµÔ∏è Suspect Online</h1>
      <div class="muted">Clue Suspect simplificado ‚Ä¢ Sala por c√≥digo ‚Ä¢ Firebase Firestore</div>
      <div class="tiny muted">Hosped√°vel no GitHub Pages (um arquivo s√≥).</div>
    </div>

    <div class="card" id="authCard">
      <h2>1) Entrar</h2>
      <div class="row">
        <input id="playerName" placeholder="Seu nome (ex: Lucas)" />
        <button id="btnAnon">Entrar (an√¥nimo)</button>
      </div>
      <div class="tiny" id="uidLine"></div>
      <div class="tiny muted" style="margin-top:6px">
        No Firebase Console: ative <b>Authentication ‚Üí Anonymous</b> e crie o <b>Firestore Database</b>.
      </div>
    </div>

    <div class="card" id="roomCard" style="display:none">
      <h2>2) Sala</h2>
      <div class="row">
        <input id="roomCode" placeholder="C√≥digo da sala (ex: AB12CD)" />
        <button id="btnCreate">Criar sala</button>
        <button id="btnJoin" class="secondary">Entrar na sala</button>
      </div>
      <div class="tiny muted">O host cria e compartilha o c√≥digo com os amigos.</div>
      <div class="tiny" id="roomStatus"></div>
      <div class="tiny err" id="errBox"></div>
    </div>

    <div class="card" id="gameCard" style="display:none">
      <h2>3) Jogo</h2>

      <div class="grid2">
        <div class="card" style="margin:0">
          <div><b>Sala:</b> <span id="roomLabel"></span></div>
          <div><b>Voc√™:</b> <span id="meLabel"></span> <span class="pill" id="hostPill" style="display:none">HOST</span></div>
          <div><b>Status:</b> <span id="phaseLabel" class="pill"></span></div>
          <div style="margin-top:10px" id="playersBox"></div>
        </div>

        <div class="card" style="margin:0">
          <div><b>Suas cartas</b> <span class="tiny muted">(ningu√©m mais v√™)</span></div>
          <div id="handBox" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card">
        <h2>A√ß√µes</h2>
        <div class="row">
          <button id="btnStart" class="secondary">Iniciar partida (host)</button>
          <button id="btnDraw">Puxar pista</button>
          <button id="btnReset" class="danger">Encerrar sala</button>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="card" style="margin:0">
            <h2>Palpite</h2>
            <select id="guessSus"></select>
            <select id="guessObj" style="margin-top:8px"></select>
            <select id="guessLoc" style="margin-top:8px"></select>
            <button id="btnGuess" style="margin-top:10px">Fazer palpite</button>
            <div class="tiny muted" style="margin-top:6px">
              (Vers√£o simples) O palpite vai pro log. Respostas podem ser no Whats/voz ‚Äî ou eu automatizo depois.
            </div>
          </div>

          <div class="card" style="margin:0">
            <h2>Acusa√ß√£o final</h2>
            <select id="accSus"></select>
            <select id="accObj" style="margin-top:8px"></select>
            <select id="accLoc" style="margin-top:8px"></select>
            <button id="btnAccuse" class="danger" style="margin-top:10px">Acusar</button>
            <div class="tiny muted" style="margin-top:6px">Se errar, voc√™ fica ‚Äúfora‚Äù (marcado no jogo).</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Pistas p√∫blicas</h2>
        <div id="publicClues"></div>
      </div>

      <div class="card">
        <h2>Log da sala</h2>
        <div class="log" id="logBox"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
      serverTimestamp, arrayUnion, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ================== FIREBASE CONFIG (SEU) ==================
    const firebaseConfig = {
      apiKey: "AIzaSyCIQ5Sonh7AVrmBCpEWr99V4UuyOH1gGyQ",
      authDomain: "clue-80365.firebaseapp.com",
      projectId: "clue-80365",
      storageBucket: "clue-80365.firebasestorage.app",
      messagingSenderId: "870296918956",
      appId: "1:870296918956:web:f8f9d95b44f8689af27809"
    };
    // ============================================================

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const fs = getFirestore(app);

    // ----- DADOS DO JOGO -----
    const SUSPECTS = ["Alice", "Bruno", "Carla", "Diego", "Elisa", "F√°bio"];
    const OBJECTS  = ["Chave", "Livro", "Copo", "Corda", "Tesoura", "Lanterna"];
    const LOCATIONS= ["Cozinha", "Sala", "Quarto", "Jardim", "Garagem", "Escrit√≥rio"];

    const CLUES = [
      { text:"O suspeito N√ÉO usa √≥culos." },
      { text:"O culpado √© algu√©m cujo nome come√ßa com vogal." },
      { text:"O objeto N√ÉO √© cortante." },
      { text:"O objeto √© algo que d√° pra segurar com uma m√£o." },
      { text:"N√£o foi em um lugar de descanso." },
      { text:"Foi em um ambiente com ‚Äúmesa‚Äù por perto." },
      { text:"N√£o foi no Jardim e n√£o foi a Lanterna." }
    ];

    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const safeUpper = (s) => (s||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,10);

    function shuffle(arr){
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function randomRoomCode(){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out="";
      for(let i=0;i<6;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }
    function showErr(e){
      console.error(e);
      const msg = (e && (e.message || e.code)) ? `${e.code || ""} ${e.message || ""}`.trim() : String(e);
      $("errBox").textContent = "Erro: " + msg;
      alert("Erro:\n" + msg);
    }

    // ---------- state ----------
    let uid = null;
    let meName = "";
    let room = null;
    let isHost = false;
    let unsubRoom = null;
    let lastRoomData = null;

    // UI init select options
    function fillSelect(sel, arr){
      sel.innerHTML = arr.map(x => `<option value="${x}">${x}</option>`).join("");
    }
    fillSelect($("guessSus"), SUSPECTS);
    fillSelect($("guessObj"), OBJECTS);
    fillSelect($("guessLoc"), LOCATIONS);
    fillSelect($("accSus"), SUSPECTS);
    fillSelect($("accObj"), OBJECTS);
    fillSelect($("accLoc"), LOCATIONS);

    // ---------- auth ----------
    $("btnAnon").onclick = async () => {
      try{
        meName = $("playerName").value.trim();
        if(!meName) return alert("Coloque seu nome üôÇ");
        await signInAnonymously(auth);
      } catch(e){ showErr(e); }
    };

    onAuthStateChanged(auth, (user) => {
      if(!user) return;
      uid = user.uid;
      $("uidLine").textContent = `Conectado ‚úÖ (uid: ${uid.slice(0,8)}‚Ä¶)`;
      $("roomCard").style.display = "";
      $("btnAnon").disabled = true;
      $("playerName").disabled = true;
    });

    // ---------- Firestore data model (simples) ----------
    // rooms/{ROOM}
    //   hostId, phase, createdAt
    //   players: { [uid]: { name, alive } }
    //   hands: { [uid]: ["Suspeito: X", ...] }
    //   clueDeck: [{text}], clueIndex
    //   publicClues: [{text, at}]
    //   log: [{text, at}]
    //   mystery: {suspect, object, location}  (‚ö†Ô∏è simples/sem anti-trapa√ßa)

    function roomDocRef(code){ return doc(fs, "rooms", code); }

    // ---------- room ----------
    $("btnCreate").onclick = async () => {
      try{
        $("errBox").textContent = "";
        const code = safeUpper($("roomCode").value) || randomRoomCode();
        $("roomCode").value = code;
        await joinOrCreate(code, true);
      } catch(e){ showErr(e); }
    };

    $("btnJoin").onclick = async () => {
      try{
        $("errBox").textContent = "";
        const code = safeUpper($("roomCode").value);
        if(!code) return alert("Digite o c√≥digo da sala.");
        await joinOrCreate(code, false);
      } catch(e){ showErr(e); }
    };

    async function joinOrCreate(code, createIfMissing){
      room = code;
      const rref = roomDocRef(room);
      const snap = await getDoc(rref);

      if(!snap.exists()){
        if(!createIfMissing) return alert("Sala n√£o existe. Pe√ßa o c√≥digo certo ou crie uma nova.");
        await setDoc(rref, {
          createdAt: serverTimestamp(),
          hostId: uid,
          phase: "lobby",
          players: {},
          hands: {},
          publicClues: [],
          log: []
        }, { merge: true });
        await pushLog(`Sala criada por ${meName}. C√≥digo: ${room}`);
      }

      // add/update me in players
      await updateDoc(rref, {
        [`players.${uid}`]: { name: meName, alive: true }
      });

      // subscribe
      if(unsubRoom) unsubRoom();
      $("roomStatus").textContent = `Entrou na sala ${room}.`;
      $("roomLabel").textContent = room;
      $("meLabel").textContent = meName;

      $("gameCard").style.display = "";
      $("roomCard").style.display = "none";
      $("authCard").style.display = "none";

      unsubRoom = onSnapshot(rref, (docSnap) => {
        const data = docSnap.data();
        if(!data) return;
        lastRoomData = data;

        isHost = data.hostId === uid;
        $("hostPill").style.display = isHost ? "inline-block" : "none";
        $("phaseLabel").textContent = data.phase || "lobby";

        $("btnStart").disabled = !isHost || (data.phase !== "lobby");
        $("btnReset").disabled = !isHost;

        renderPlayers(data.players || {});
        renderHand((data.hands && data.hands[uid]) ? data.hands[uid] : []);
        renderPublicClues(data.publicClues || []);
        renderLog(data.log || []);

        const meAlive = data.players?.[uid]?.alive !== false;
        $("btnDraw").disabled = data.phase !== "playing" || !meAlive;
        $("btnGuess").disabled = data.phase !== "playing" || !meAlive;
        $("btnAccuse").disabled = data.phase !== "playing" || !meAlive;
      });
    }

    function renderPlayers(players){
      const entries = Object.entries(players);
      if(entries.length === 0){
        $("playersBox").innerHTML = `<span class="muted">Sem jogadores.</span>`;
        return;
      }
      $("playersBox").innerHTML = entries.map(([id,p]) => {
        const alive = p.alive === false ? "‚ùå fora" : "‚úÖ";
        const you = id === uid ? " ‚Ä¢ voc√™" : "";
        return `<span class="pill">${alive} ${escapeHtml(p.name||"Jogador")}${you}</span>`;
      }).join(" ");
    }

    function renderHand(hand){
      if(!hand || hand.length===0){
        $("handBox").innerHTML = `<div class="muted">Ainda sem cartas (o host precisa iniciar).</div>`;
        return;
      }
      $("handBox").innerHTML = hand.map(c => `<span class="pill">${escapeHtml(c)}</span>`).join(" ");
    }

    function renderPublicClues(clues){
      if(!clues || clues.length===0){
        $("publicClues").innerHTML = `<div class="muted">Nenhuma pista ainda.</div>`;
        return;
      }
      $("publicClues").innerHTML = clues.map(c => {
        const t = c.at?.seconds ? new Date(c.at.seconds*1000) : new Date(c.at || Date.now());
        return `<div class="pill">üß© ${escapeHtml(c.text)} <span class="tiny muted">(${t.toLocaleTimeString()})</span></div>`;
      }).join("");
    }

    function renderLog(logArr){
      const items = [...(logArr||[])].sort((a,b)=>{
        const atA = a.at?.seconds ? a.at.seconds*1000 : (a.at||0);
        const atB = b.at?.seconds ? b.at.seconds*1000 : (b.at||0);
        return atA - atB;
      });
      $("logBox").textContent = items.map(i => {
        const t = i.at?.seconds ? new Date(i.at.seconds*1000) : new Date(i.at || Date.now());
        return `[${t.toLocaleTimeString()}] ${i.text}`;
      }).join("\n");
      $("logBox").scrollTop = $("logBox").scrollHeight;
    }

    async function pushLog(text){
      if(!room) return;
      const rref = roomDocRef(room);
      await updateDoc(rref, {
        log: arrayUnion({ text, at: new Date() })
      });
    }

    // ---------- actions ----------
    $("btnStart").onclick = async () => {
      try{
        if(!room || !isHost) return;
        const rref = roomDocRef(room);
        const snap = await getDoc(rref);
        const data = snap.data();
        if(!data || data.phase !== "lobby") return;

        const players = data.players ? Object.keys(data.players) : [];
        if(players.length < 2) return alert("Entre com pelo menos 2 jogadores pra ficar legal üôÇ");

        const mystery = {
          suspect: choice(SUSPECTS),
          object: choice(OBJECTS),
          location: choice(LOCATIONS)
        };

        const allCards = [
          ...SUSPECTS.map(x=>`Suspeito: ${x}`),
          ...OBJECTS.map(x=>`Objeto: ${x}`),
          ...LOCATIONS.map(x=>`Lugar: ${x}`)
        ];

        const mysteryCards = new Set([
          `Suspeito: ${mystery.suspect}`,
          `Objeto: ${mystery.object}`,
          `Lugar: ${mystery.location}`
        ]);

        const deck = shuffle(allCards.filter(c => !mysteryCards.has(c)));

        const hands = {};
        players.forEach(pid => hands[pid] = []);
        let idx=0;
        for(const card of deck){
          const pid = players[idx % players.length];
          hands[pid].push(card);
          idx++;
        }

        const clueDeck = shuffle(CLUES);

        await updateDoc(rref, {
          phase: "playing",
          mystery,        // ‚ö†Ô∏è simples (sem anti-trapa√ßa)
          hands,
          clueDeck,
          clueIndex: 0,
          publicClues: [],
        });

        await pushLog(`üé¨ Partida iniciada! (Host: ${meName})`);
        await pushLog(`Objetivo: descobrir suspeito + objeto + lugar.`);
      } catch(e){ showErr(e); }
    };

    $("btnDraw").onclick = async () => {
      try{
        if(!room) return;
        const rref = roomDocRef(room);
        const snap = await getDoc(rref);
        const data = snap.data();
        if(!data || data.phase !== "playing") return;

        const idx = data.clueIndex || 0;
        const deck = data.clueDeck || [];
        if(idx >= deck.length) return alert("Acabaram as pistas!");

        const clue = deck[idx];
        await updateDoc(rref, {
          clueIndex: idx + 1,
          publicClues: arrayUnion({ text: clue.text, at: new Date() })
        });
        await pushLog(`üß© ${meName} puxou uma pista: ${clue.text}`);
      } catch(e){ showErr(e); }
    };

    $("btnGuess").onclick = async () => {
      try{
        if(!room) return;
        const s = $("guessSus").value;
        const o = $("guessObj").value;
        const l = $("guessLoc").value;
        await pushLog(`‚ùì Palpite de ${meName}: ${s} + ${o} + ${l}`);
      } catch(e){ showErr(e); }
    };

    $("btnAccuse").onclick = async () => {
      try{
        if(!room) return;
        const rref = roomDocRef(room);
        const snap = await getDoc(rref);
        const data = snap.data();
        if(!data || data.phase !== "playing") return;

        const s = $("accSus").value;
        const o = $("accObj").value;
        const l = $("accLoc").value;

        const ok =
          data.mystery?.suspect === s &&
          data.mystery?.object === o &&
          data.mystery?.location === l;

        if(ok){
          await pushLog(`üèÜ ${meName} ACUSOU e ACERTOU! Era ${s} com ${o} em ${l}.`);
          await updateDoc(rref, { phase:"finished" });
          alert(`Voc√™ venceu! Era ${s} com ${o} em ${l}.`);
        } else {
          await pushLog(`üí• ${meName} acusou e ERROU: ${s} + ${o} + ${l}. (Ficou fora)`);
          await updateDoc(rref, { [`players.${uid}.alive`]: false });
          alert("Errou! Voc√™ ficou fora da disputa (mas pode continuar assistindo).");
        }
      } catch(e){ showErr(e); }
    };

    $("btnReset").onclick = async () => {
      try{
        if(!room || !isHost) return;
        const ok = confirm("Encerrar sala e apagar tudo? (todo mundo vai sair)");
        if(!ok) return;
        await deleteDoc(roomDocRef(room));
        location.reload();
      } catch(e){ showErr(e); }
    };
  </script>
</body>
</html>
